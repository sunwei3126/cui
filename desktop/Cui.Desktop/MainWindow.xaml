<Window x:Class="Cui.Desktop.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:telerik="http://schemas.telerik.com/2008/xaml/presentation"
        xmlns:viewModels="clr-namespace:Cui.Desktop.ViewModels"
        xmlns:selectors="clr-namespace:Cui.Desktop.Selectors"
        xmlns:controls="clr-namespace:Cui.Desktop.Views.Controls"
        mc:Ignorable="d"
        Title="Common Agent UI" Height="900" Width="1400">
    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />

        <DataTemplate x:Key="UserMessageTemplate" DataType="{x:Type viewModels:MessageGroupViewModel}">
            <Border Margin="0,8" Background="#FFEEF7FF" BorderBrush="#FFB7D4F6" BorderThickness="1" CornerRadius="8" Padding="12" HorizontalAlignment="Right" MaxWidth="520">
                <StackPanel>
                    <TextBlock Text="{Binding PreviewText}" TextWrapping="Wrap" />
                    <ContentControl Content="{Binding RemainingText}" Margin="0,8,0,0">
                        <ContentControl.Style>
                            <Style TargetType="ContentControl">
                                <Setter Property="Visibility" Value="Collapsed" />
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsExpanded}" Value="True">
                                        <Setter Property="Visibility" Value="Visible" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </ContentControl.Style>
                        <ContentControl.ContentTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding}" TextWrapping="Wrap" />
                            </DataTemplate>
                        </ContentControl.ContentTemplate>
                    </ContentControl>
                    <telerik:RadButton Content="{Binding ExpandLabel}"
                                        Command="{Binding ToggleExpandCommand}"
                                        HorizontalAlignment="Right"
                                        Margin="0,8,0,0"
                                        Visibility="{Binding HasOverflowText, Converter={StaticResource BooleanToVisibilityConverter}}" />
                </StackPanel>
            </Border>
        </DataTemplate>

        <DataTemplate x:Key="AssistantMessageTemplate" DataType="{x:Type viewModels:MessageGroupViewModel}">
            <Grid Margin="0,8">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="36" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition />
                </Grid.RowDefinitions>
                <Grid Grid.Column="0" Margin="0,8,16,0">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    <Ellipse Width="12" Height="12" Fill="#FF4C8BF5" HorizontalAlignment="Center" />
                    <Rectangle Grid.Row="1" Width="2" Fill="#FFE0E0E0" HorizontalAlignment="Center" />
                </Grid>
                <Border Grid.Column="1" Background="#FFFFFFFF" BorderBrush="#FFE0E0E0" BorderThickness="1" CornerRadius="8" Padding="12">
                    <ItemsControl ItemsSource="{Binding AssistantBlocks}" Margin="0">
                        <ItemsControl.Resources>
                            <DataTemplate DataType="{x:Type viewModels:TextBlockViewModel}">
                                <telerik:RadMarkdownViewer Margin="0,0,0,12" Markdown="{Binding Markdown}" />
                            </DataTemplate>
                            <DataTemplate DataType="{x:Type viewModels:ThinkingBlockViewModel}">
                                <telerik:RadMarkdownViewer Margin="0,0,0,12" Markdown="{Binding Markdown}" Foreground="Gray" FontStyle="Italic" />
                            </DataTemplate>
                            <DataTemplate DataType="{x:Type viewModels:JsonBlockViewModel}">
                                <Border Margin="0,0,0,12" BorderBrush="#FFD0D0D0" BorderThickness="1" Padding="8" Background="#FFF9F9F9">
                                    <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto" MaxHeight="220">
                                        <TextBox Text="{Binding Json}" FontFamily="Consolas" IsReadOnly="True" BorderThickness="0" TextWrapping="Wrap" />
                                    </ScrollViewer>
                                </Border>
                            </DataTemplate>
                            <DataTemplate DataType="{x:Type viewModels:ToolUseBlockViewModel}">
                                <controls:ToolContentControl DataContext="{Binding Invocation}" Margin="0,0,0,12" />
                            </DataTemplate>
                        </ItemsControl.Resources>
                    </ItemsControl>
                </Border>
            </Grid>
        </DataTemplate>

        <DataTemplate x:Key="ErrorMessageTemplate" DataType="{x:Type viewModels:MessageGroupViewModel}">
            <Border Margin="0,8" Background="#FFFFEAEA" BorderBrush="#FFE0A0A0" BorderThickness="1" CornerRadius="8" Padding="12" MaxWidth="520">
                <StackPanel>
                    <TextBlock Text="{Binding CombinedUserText}" TextWrapping="Wrap" Foreground="#FFB00000" />
                </StackPanel>
            </Border>
        </DataTemplate>

        <selectors:MessageTemplateSelector x:Key="MessageTemplateSelector"
                                           UserTemplate="{StaticResource UserMessageTemplate}"
                                           AssistantTemplate="{StaticResource AssistantMessageTemplate}"
                                           ErrorTemplate="{StaticResource ErrorMessageTemplate}" />
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <Border Grid.Row="0" Background="#FF1F2937" Padding="16">
            <DockPanel>
                <TextBlock Text="Common Agent UI" Foreground="White" FontSize="20" FontWeight="SemiBold" DockPanel.Dock="Left" />
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Right">
                    <telerik:RadButton Content="加载示例会话" Command="{Binding LoadSampleConversationCommand}" />
                </StackPanel>
            </DockPanel>
        </Border>

        <telerik:RadListView Grid.Row="1"
                             ItemsSource="{Binding Messages}"
                             ItemTemplateSelector="{StaticResource MessageTemplateSelector}"
                             SelectionMode="Single"
                             IsSynchronizedWithCurrentItem="False"
                             SelectionChanged="RadListView_SelectionChanged"
                             Background="#FFF5F6F8"
                             BorderThickness="0"
                             Margin="0"
                             IsScrollingEnabled="True" />

        <Border Grid.Row="2" Padding="12" Background="#FFF5F6F8" BorderThickness="0,1,0,0" BorderBrush="#FFE0E0E0">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Visibility="{Binding ShowStreamingIndicator, Converter={StaticResource BooleanToVisibilityConverter}}">
                <Ellipse Width="10" Height="10" Fill="#FF4C8BF5">
                    <Ellipse.Triggers>
                        <EventTrigger RoutedEvent="Loaded">
                            <BeginStoryboard>
                                <Storyboard RepeatBehavior="Forever" AutoReverse="True">
                                    <DoubleAnimation Storyboard.TargetProperty="Opacity" From="1" To="0.2" Duration="0:0:0.6" />
                                </Storyboard>
                            </BeginStoryboard>
                        </EventTrigger>
                    </Ellipse.Triggers>
                </Ellipse>
                <TextBlock Text="助手正在思考..." Foreground="#FF4C4C4C" Margin="8,0,0,0" />
            </StackPanel>
        </Border>
    </Grid>
</Window>

<UserControl x:Class="Cui.Desktop.Views.Controls.ToolContentControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:telerik="http://schemas.telerik.com/2008/xaml/presentation"
             xmlns:viewModels="clr-namespace:Cui.Desktop.ViewModels"
             xmlns:selectors="clr-namespace:Cui.Desktop.Selectors"
             x:Name="Root">
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />

        <DataTemplate x:Key="ReadToolTemplate" DataType="{x:Type viewModels:ReadToolContentViewModel}">
            <StackPanel>
                <TextBlock Text="文件路径" FontWeight="SemiBold" />
                <TextBlock Text="{Binding Path}" Margin="0,2,0,8" TextWrapping="Wrap" />
                <telerik:RadExpander Header="内容预览" IsExpanded="True">
                    <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto" MaxHeight="180">
                        <TextBlock Text="{Binding Preview}" TextWrapping="Wrap" FontFamily="Consolas" />
                    </ScrollViewer>
                </telerik:RadExpander>
            </StackPanel>
        </DataTemplate>

        <DataTemplate x:Key="EditToolTemplate" DataType="{x:Type viewModels:EditToolContentViewModel}">
            <StackPanel>
                <TextBlock Text="目标文件" FontWeight="SemiBold" />
                <TextBlock Text="{Binding Path}" Margin="0,2,0,8" TextWrapping="Wrap" />
                <TextBlock Text="修改预览" FontWeight="SemiBold" />
                <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto" MaxHeight="200">
                    <TextBox Text="{Binding Diff}" IsReadOnly="True" TextWrapping="NoWrap" FontFamily="Consolas" BorderThickness="0" />
                </ScrollViewer>
            </StackPanel>
        </DataTemplate>

        <DataTemplate x:Key="TaskChildTemplate" DataType="{x:Type viewModels:TaskChildMessageViewModel}">
            <Border Padding="8" Margin="0,4,0,0" Background="#FFF3F3F3" CornerRadius="4">
                <StackPanel>
                    <TextBlock Text="{Binding Summary}" TextWrapping="Wrap" />
                    <TextBlock Text="{Binding Timestamp, StringFormat='{}{0:HH:mm:ss}'}" FontSize="11" Foreground="Gray" />
                </StackPanel>
            </Border>
        </DataTemplate>

        <DataTemplate x:Key="TaskToolTemplate" DataType="{x:Type viewModels:TaskToolContentViewModel}">
            <StackPanel>
                <TextBlock Text="子任务明细" FontWeight="SemiBold" />
                <ItemsControl ItemsSource="{Binding Children}" ItemTemplate="{StaticResource TaskChildTemplate}" />
            </StackPanel>
        </DataTemplate>

        <DataTemplate x:Key="GenericToolTemplate" DataType="{x:Type viewModels:GenericToolContentViewModel}">
            <StackPanel>
                <TextBlock Text="调用参数" FontWeight="SemiBold" />
                <ItemsControl ItemsSource="{Binding Arguments}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Grid Margin="0,2,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="160" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="{Binding Key}" FontWeight="SemiBold" />
                                <TextBlock Grid.Column="1" Text="{Binding Value}" TextWrapping="Wrap" Margin="8,0,0,0" />
                            </Grid>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
                <TextBlock Text="结果输出" FontWeight="SemiBold" Margin="0,12,0,0" />
                <Border BorderBrush="#FFD0D0D0" BorderThickness="1" Padding="8" Background="#FFF9F9F9" Margin="0,4,0,0">
                    <TextBlock Text="{Binding Output}" TextWrapping="Wrap" />
                </Border>
            </StackPanel>
        </DataTemplate>

        <selectors:ToolContentTemplateSelector x:Key="ToolContentTemplateSelector"
                                               ReadTemplate="{StaticResource ReadToolTemplate}"
                                               EditTemplate="{StaticResource EditToolTemplate}"
                                               TaskTemplate="{StaticResource TaskToolTemplate}"
                                               GenericTemplate="{StaticResource GenericToolTemplate}" />
    </UserControl.Resources>

    <Border Padding="12" Background="#FFFFFFFF" CornerRadius="8" BorderBrush="#FFE0E0E0" BorderThickness="1">
        <StackPanel>
            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                <Border Width="24" Height="24" CornerRadius="12" Background="#FF4C8BF5">
                    <TextBlock Text="{Binding Content.IconGlyph}" FontFamily="Segoe MDL2 Assets" VerticalAlignment="Center" HorizontalAlignment="Center" />
                </Border>
                <TextBlock Text="{Binding DisplayName}" FontWeight="SemiBold" VerticalAlignment="Center" Margin="8,0,0,0" />
                <TextBlock Text="{Binding Result.Status}" Foreground="Gray" VerticalAlignment="Center" Margin="8,0,0,0" />
                <telerik:RadBusyIndicator Margin="12,0,0,0" IsBusy="{Binding Result.IsPending}" Width="32" Height="32" />
            </StackPanel>

            <ContentControl Margin="0,12,0,0"
                            Content="{Binding Content}"
                            ContentTemplateSelector="{StaticResource ToolContentTemplateSelector}">
                <ContentControl.Style>
                    <Style TargetType="ContentControl">
                        <Setter Property="Visibility" Value="Visible" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding Result.IsPending}" Value="True">
                                <Setter Property="Visibility" Value="Collapsed" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </ContentControl.Style>
            </ContentControl>

            <telerik:RadExpander Header="错误详情"
                                  Margin="0,8,0,0"
                                  Visibility="{Binding Result.IsError, Converter={StaticResource BooleanToVisibilityConverter}}"
                                  IsExpanded="False">
                <TextBlock Text="{Binding Result.ErrorMessage}" TextWrapping="Wrap" Foreground="IndianRed" />
            </telerik:RadExpander>
        </StackPanel>
    </Border>
</UserControl>
